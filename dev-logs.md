# 实验目标描述

1. 在小脚丫 FPGA 上实现一个迷你 CPU, 支持 [14条指令](http://recc.robertelder.org/)

2. 在迷你 CPU 上运行[轻量级操作系统](https://github.com/RobertElderSoftware/recc)

3. 改进轻量级操作系统, 包括
    * 增加非对等虚拟内存
    * 增加权限管理
    * 改进进程管理
    * ...

下文中使用 recc 来代指这整个 CPU, 编译, OS 的项目.


------------------------------------------------------------------------------

# 已有工作

*TODO*

------------------------------------------------------------------------------

# 日志
__写日志时请按照逆序时间排序__

## 4月15日
* 裁剪 os 取得重大成就.
	1. 从操作系统中删除文件系统和系统内编译器后,
		kernel image 变为 42235 条 loader 指令.
		相当于在原 kernel image 基础上缩减了 97.63% 的内容.
	2. 因为 kernel image 作为目标文件, 不需要向其他模块暴露符号信息.
		据此从 kernel image 中删去符号信息后,
		kernel image 变为 38015 条 loader 指令.
		又缩减了 10.00% 的内容.
* 更新编译系统的笔记.
* 接下来裁剪 os 的方向
	1. 优化 recc 代码生成. 已有代码生成中包含大量冗余, 如默认返回值.
	2. 优化指令集, 根据 os 代码的特性加入新指令, 如 push, pop, lui 等.

## 4月13日至4月14日
继续研读内核构建过程, 以及研究编译链接结构

## 4月12日
* 实现 CPU
    1. 完成除了乘法，除法之外的所有指令
    2. 通过了已完成部分的仿真测试
    
* 继续尝试使用Flash，还是失败了
    失败的日志记录与经验教训在memo.md中进行了记录，需要进一步的尝试。

* 发现因为片内RAM是不可初始化的，而且确认了没有片内ROM。
    1. 若想要运行代码，需要直接在Flash中先执行一段代码将boot_loader导入内存，然后执行boot_loader，或者直接在Flash中执行boot_loader。
    2. 为了适应在Flash中运行代码的超高延迟，很可能需要调整流水线

## 4月11日
* 开始实现 CPU
    1. 完成脚手架搭建
    2. 成功实现并仿真测试通过第一条指令 `add`.

## 4月10日
* 与向勇老师交流了项目目标，目前确认项目进展顺序如下：
    1. 第一阶段：在现有硬件上实现最简单的CPU，能够运行监控程序（无中断）。
    2. 第二阶段：移植带中断的OS到CPU中。
    3. 第三阶段：在OS中尝试加入虚拟存储。
    4. 第四阶段：在OS中尝试加入权限切换。

* 任意阶段发现FPGA资源不够，且尝试修剪无效时，改为使用更完善的硬件。但需尽力在现有的微型FPGA上实现尽可能多的功能。

## 4月9日
* 交流了项目中主要存在的问题, 并完成大体分工
    1. 在有限的硬件资源上实现一个完整的 CPU (可能还要支持透明TLB)
    2. 将操作系统 (kernel image 6~7 MB) 裁剪, 装入 32KB 的用户flash.
    3. 分工为 zty: kernel, wys: cpu, dzy: compiler

## 4月8日
* 交流会: 我们需要实现的不仅仅是他模拟器的 CPU, 更要考虑将课程中知识点应用.
    1. 我们如何完成对页式内存访问的管理?
        模拟器中是没有 TLB 的, 陈老师希望我们能够把 TLB 直接做到硬件里, 这样软件更简单.
        这样就要考虑软硬件协同, 包括切换页表的时候刷新TLB等.
    2. 最好目标是, 我们写的 CPU (以及编译器) 能够使得 ucoreplus 被编译之后放到 FPGA 中.

* 阅读编译器, 理解了最初的版本 (2d0e734)

## 4月7日
* 发现 kernel image 过大 (光是指令就有 1 MB), 难以写入 FPGA 中 (BRAM 378Kb, UserFlash 32KB).

*TODO*: 研究裁剪 OS / 优化 kernel image 的大小的方法

## 4月6日
* 更仔细的阅读 recc 源代码, 开始研究 recc 编译器

## 4月4日至4月5日
* 尝试使用片内 flash, 失败.

* 搁置片内 flash 的问题, 等待其他组员一起解决.

## 4月3日
* 片内 RAM 接口摸清楚了.

* 尝试使用片内 flash, 失败.

## 4月1日至4月2日
* FPGA 的 Helloworld 在板子上无法运行, 烧入总是出现 jtag 等的问题.  完全按照 max10 的开发手册也不行.
    详情参见 [memo](https://github.com/AndroidNewsHomework/lightweight-os-dev-docs/blob/master/memo.md#%E6%9D%BF%E5%AD%90%E5%9E%8B%E5%8F%B7%E9%97%AE%E9%A2%98).
    解决是, 发现开发手册中的问题: FPGA 型号不对. 修正后 FPGA 成功运行 Helloworld

## 4月1日前
* 环境配置成功, 重现了 recc, 一切正常

